<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order Failed | Aromix</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .failed-container {
      max-width: 600px;
      margin: 50px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 30px;
      text-align: center;
    }
    .failed-icon {
      font-size: 60px;
      color: #dc3545; /* Bootstrap red */
      margin-bottom: 20px;
    }
    .order-details {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .order-details li {
      font-size: 16px;
      margin-bottom: 8px;
    }
    .btn-group-custom {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 15px;
    }
  </style>
</head>
<body class="bg-light">

  <!-- Header -->
  <%- include('../../partials/header') %>

  <div class="container">
    <div class="failed-container">
      <div class="failed-icon">
        <i class="bi bi-x-circle-fill"></i>
      </div>
      <h3 class="text-danger fw-bold">Payment Failed</h3>
      <p class="text-muted">
        Oops! Your payment could not be completed.  
        Donâ€™t worry, you can retry your payment or choose another payment method.
      </p>

      <!-- Order Details -->
      <ul class="order-details list-unstyled">
        <li><strong>Status:</strong> Payment Failed</li>
        <li><strong>Your Order ID:</strong> <span class="text-danger fw-bold"><%= order.orderId %></span></li>
      </ul>

      <!-- Buttons -->
      <div class="btn-group-custom">
        <button class="btn btn-danger" onclick="retryPayment(`<%= order._id %>`)">
          <i class="bi bi-arrow-repeat"></i> Retry Payment
        </button>
        <a href="/users-products/discover" class="btn btn-outline-danger">
          <i class="bi bi-cart"></i> Continue Shopping
        </a>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <%- include('../../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    async function retryPayment(orderId) {
      try {
        // Call backend to create a new Razorpay order
        const res = await axios.post(`/user-oder/retry-payment/${orderId}`);
        if (res.data.success) {
          const { razorpayOrder, order } = res.data;

          const options = {
            key: "<%= process.env.RAZORPAY_KEY_ID %>",
            amount: razorpayOrder.amount,
            currency: razorpayOrder.currency,
            name: "Aromix",
            description: "Retry Payment",
            order_id: razorpayOrder.id,
            handler: async function (response) {
              try {
                const verifyRes = await axios.post('/user-oder/verify-razorpay-payment', {
                  orderId: razorpayOrder.id,
                  paymentId: response.razorpay_payment_id,
                  signature: response.razorpay_signature,
                  tempOrderId: order._id
                });
                if (verifyRes.data.success) {
                  window.location.href = `/user-oder/oder-status/${order._id}`;
                } else {
                  window.location.href = `/user-oder/payment-failed/${order._id}`;
                }
              } catch (err) {
                window.location.href = `/user-oder/payment-failed/${order._id}`;
              }
            },
            modal: {
              ondismiss: function () {
                // User closed Razorpay popup
                window.location.href = `/user-oder/payment-failed/${order._id}`;
              }
            },
            theme: { color: "#2e0e46" }
          };

          const rzp = new Razorpay(options);
          rzp.on("payment.failed", function () {
            window.location.href = `/user-oder/payment-failed/${order._id}`;
          });
          rzp.open();
        }
      } catch (err) {
        console.error(err);
        showToast( err.response.data.message || "Error retrying payment. Please try again later.","danger");
      }
    }

    function showToast(message, type="primary"){
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${type} border-0 show position-fixed bottom-0 end-0 m-3`;
      toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div>
      <button class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      document.body.appendChild(toast);
      setTimeout(()=>toast.remove(),3000);
    }
  </script>
</body>
</html>
