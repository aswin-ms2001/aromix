<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout | Aromix</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    .address-card {
      min-width: 250px;
      max-width: 250px;
      background: #fff;
      border-radius: 6px;
      padding: 15px;
      border: 1px solid #ddd;
    }
    .address-scroll {
      display: flex;
      gap: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .address-scroll::-webkit-scrollbar {
      height: 8px;
    }
    .address-scroll::-webkit-scrollbar-thumb {
      background: #ccc;
      border-radius: 4px;
    }
  </style>
</head>
<body class="bg-light">

  <!-- ✅ Header -->
  <%- include('../partials/header') %>

  <div class="container my-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/users-profile/profile-front/<%- currentUser._id %>" class="text-decoration-none text-secondary">My Profile</a></li>
        <li class="breadcrumb-item active" aria-current="page"><strong>Checkout</strong></li>
      </ol>
    </nav>

    <div class="row">
      <!-- ✅ Left: Address & Payment -->
      <div class="col-md-8 mb-3">
        
        <!-- Address Section -->
        <div class="card p-4 mb-3 shadow-sm">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-danger fw-bold">Delivery Address</h5>
            <button class="btn btn-outline-danger btn-sm" onclick="window.location.href='/users-address/manage'">Manage Addresses</button>
          </div>

          <% if (addresses && addresses.length > 0) { %>
            <div class="address-scroll">
              <% addresses.forEach(addr => { %>
                <div class="address-card <%= addr.isDefault ? 'border border-danger' : '' %>">
                  <h6><%= addr.name %></h6>
                  <p class="mb-1"><%= addr.house %>, <%= addr.street %></p>
                  <p class="mb-1"><%= addr.city %>, <%= addr.state %></p>
                  <p class="mb-1"><%= addr.country %> - <%= addr.pincode %></p>
                  <small class="text-muted">Mobile: <%= addr.mobile %></small>
                  <div class="mt-2">
                    <button class="btn btn-outline-danger btn-sm w-100" onclick="selectOrderAddress('<%= addr._id %>')">
                      <%= addr.isDefault ? 'Default Address' : 'Deliver Here' %>
                    </button>
                  </div>
                </div>
              <% }) %>
            </div>
          <% } else { %>
            <p class="text-muted">No address found. Please add an address to proceed.</p>
          <% } %>
        </div>

        <!-- Payment Section -->
        <div class="card p-4 mb-3 shadow-sm">
          <h5 class="text-danger fw-bold mb-3">Payment Method</h5>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="cod" checked>
            <label class="form-check-label fw-bold" for="cod">Cash on Delivery</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="paymentMethod" id="upi" value="upi" disabled>
            <label class="form-check-label text-muted" for="upi">UPI (Coming Soon)</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="radio" name="paymentMethod" id="card" value="card" disabled>
            <label class="form-check-label text-muted" for="card">Credit/Debit Card (Coming Soon)</label>
          </div>
        </div>

        <!-- Apply Coupon -->
        <div class="card p-4 shadow-sm">
          <h5 class="text-danger fw-bold mb-3">Apply Coupon</h5>
          <div class="input-group">
            <input type="text" class="form-control" placeholder="Enter Coupon Code" disabled>
            <button class="btn btn-outline-danger" disabled>Apply</button>
          </div>
          <small class="text-muted">Coupon feature coming soon!</small>
        </div>
      </div>

      <!-- ✅ Right: Order Summary -->
      <div class="col-md-4">
        <div class="card p-4 shadow-sm">
          <h5 class="fw-bold text-danger mb-3">Order Summary</h5>
          <hr>
          <% cart.forEach(item => { %>
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <img src="<%= item.variant.images[0] %>" alt="product" class="rounded me-2" style="width:50px; height:50px;">
                <span class="fw-bold"><%= item.productId.name %></span><br>
                <small class="text-muted">Qty: <%= item.quantity %></small>
              </div>
              <span class="fw-bold text-success">₹<%= item.itemTotal %></span>
            </div>
          <% }) %>
          <hr>
          <p class="d-flex justify-content-between mb-1"><span>Subtotal:</span> <span>₹<%= subtotal %></span></p>
          <p class="d-flex justify-content-between mb-1"><span>Delivery:</span> <span>₹<%= subtotal > 1000 ? 0 : 50 %></span></p>
          <hr>
          <h5 class="d-flex justify-content-between fw-bold">Total: <span>₹<%= subtotal > 1000 ? subtotal : subtotal + 50 %></span></h5>
          <button class="btn btn-danger w-100 mt-3" onclick="placeOrder()">Place Order</button>
          <button class="btn btn-outline-secondary w-100 mt-2" onclick="window.location.href='/users-products/discover'">Return to Shop</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Modal: Address Required -->
  <div class="modal fade" id="addressModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-body text-center">
          <p class="fs-5 text-danger mb-3">Please add or select an address before placing the order.</p>
          <button class="btn btn-danger" onclick="window.location.href='/users-address/manage'">Add Address</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    let selectedAddressId = "<%= defaultAddress ? defaultAddress._id : '' %>";

    function selectOrderAddress(addressId) {
      selectedAddressId = addressId;
      showToast("Address selected for delivery", "success");
    }

    function placeOrder() {
      if (!selectedAddressId) {
        const modal = new bootstrap.Modal(document.getElementById('addressModal'));
        modal.show();
        return;
      }

      const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

      axios.post('/users-order/place-order', {
        addressId: selectedAddressId,
        paymentMethod
      })
      .then(res => {
        if (res.data.success) {
          showToast(res.data.message, "success");
          setTimeout(() => window.location.href = '/order-confirmation', 1500);
        }
      })
      .catch(err => {
        showToast(err.response?.data?.message || "Something went wrong", "danger");
      });
    }

    function showToast(message, type = "primary") {
      const toast = document.createElement("div");
      toast.className = `toast align-items-center text-white bg-${type} border-0 show position-fixed bottom-0 end-0 m-3`;
      toast.role = "alert";
      toast.style.zIndex = "1055";
      toast.style.minWidth = "300px";
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${message}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>`;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
