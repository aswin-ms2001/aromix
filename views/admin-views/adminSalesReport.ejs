<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Sales Report | Aromix</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link rel="stylesheet" href="/css/admin-css/adminProducts.css">
  <link rel="stylesheet" href="/css/admin-css/sidebar.css">
</head>
<body>
<div class="d-flex">
  <%- include('./partials/sidebar') %>

  <div class="flex-grow-1 p-4" style="background-color:#1b1b1b; min-height:100vh;">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h2 class="text-white">Sales Report</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-light" onclick="downloadReport('pdf')"><i class="bi bi-filetype-pdf"></i> Download Full Period PDF</button>
        <button class="btn btn-outline-light" onclick="downloadReport('excel')"><i class="bi bi-filetype-csv"></i> Download Full Period Excel</button>
      </div>
    </div>

    <!-- Filters -->
    <div class="card p-3 mb-4" style="background-color:#2e0e46; border:none; border-radius:20px;">
      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="text-white mb-2">Range</label>
          <select id="range" class="form-select" onchange="toggleCustomDates()">
            <option value="day" <%= range==='day'?'selected':'' %>>1 Day</option>
            <option value="week" <%= range==='week'?'selected':'' %>>1 Week</option>
            <option value="month" <%= range==='month'?'selected':'' %>>1 Month</option>
            <option value="year" <%= range==='year'?'selected':'' %>>1 Year</option>
            <option value="custom" <%= range==='custom'?'selected':'' %>>Custom</option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="text-white mb-2">Start</label>
          <input id="startDate" type="datetime-local" class="form-control" value="<%= startDate || '' %>">
        </div>
        <div class="col-md-3">
          <label class="text-white mb-2">End</label>
          <input id="endDate" type="datetime-local" class="form-control" value="<%= endDate || '' %>">
        </div>
        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-outline-light flex-grow-1" onclick="applyFilters()"><i class="bi bi-funnel"></i> Apply</button>
          <button class="btn btn-outline-danger" onclick="clearFilters()"><i class="bi bi-x-circle"></i></button>
        </div>
      </div>
    </div>

    <!-- Metrics -->
    <div class="row g-3 mb-4">
      <div class="col-md-4">
        <div class="card p-3 text-white" style="background-color:#2e0e46; border:none; border-radius:20px;">
          <div class="d-flex justify-content-between">
            <div>Overall Sales Count</div>
            <div class="fw-bold"><%= metrics.count %></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-white" style="background-color:#2e0e46; border:none; border-radius:20px;">
          <div class="d-flex justify-content-between">
            <div>Overall Order Amount</div>
            <div class="fw-bold">₹<%= metrics.amount %></div>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card p-3 text-white" style="background-color:#2e0e46; border:none; border-radius:20px;">
          <div class="d-flex justify-content-between">
            <div>Overall Discount</div>
            <div class="fw-bold">₹<%= metrics.discount %></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="card p-3" style="background-color:#2e0e46; border:none; border-radius:20px;">
      <div class="table-responsive">
        <table class="table text-white mb-0">
          <thead>
            <tr style="background-color:#aa5de8;">
              <th>Order ID</th>
              <th>Date</th>
              <th>Customer</th>
              <th>Payment</th>
              <th>Status</th>
              <th>Products</th>
              <th>Subtotal</th>
              <th>Discount</th>
              <th>Shipping</th>
              <th>Grand Total</th>
            </tr>
          </thead>
          <tbody>
            <% orders.forEach(o => { %>
              <tr>
                <td><strong><%= o.orderId %></strong></td>
                <td><%= new Date(o.createdAt).toLocaleString('en-IN') %></td>
                <td>
                  <div><%= o.userId.name %></div>
                  <small class="text-muted"><%= o.userId.email %></small>
                </td>
                <td>
                  <span class="badge bg-<%= 
                    o.paymentMethod === 'COD' ? 'warning' :
                    o.paymentMethod === 'RAZORPAY' ? 'success' :
                    o.paymentMethod === 'WALLET' ? 'info' : 'secondary'
                  %>"><%= o.paymentMethod %></span>
                </td>
                <td>
                  <span class="badge bg-<%= 
                    o.orderStatus === 'Delivered' ? 'success' :
                    o.orderStatus === 'Cancelled' ? 'danger' :
                    o.orderStatus === 'Shipped' ? 'info' :
                    o.orderStatus === 'Out for Delivery' ? 'warning' :
                    o.orderStatus === 'Confirmed' ? 'primary' : 'secondary'
                  %>"><%= o.orderStatus %></span>
                </td>
                <td>
                  <div class="small">
                    <% o.items.forEach((item, index) => { %>
                      <div><%= item.productId.name %> (Qty: <%= item.quantity %>)</div>
                    <% }) %>
                  </div>
                </td>
                <td>₹<%= o.subtotal %></td>
                <td>₹<%= o.discount %></td>
                <td>₹<%= o.shippingCharge %></td>
                <td><strong>₹<%= o.grandTotal %></strong></td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="d-flex justify-content-between mt-4 text-white">
        <div>
          Page <%= currentPage %> of <%= totalPages %> (<%= totalOrders %> orders)
        </div>
        <div class="d-flex gap-2">
          <% if (currentPage > 1) { %>
            <a class="btn btn-outline-light btn-sm" href="?<%- (()=>{ const p=new URLSearchParams({ ...Object.fromEntries(new URLSearchParams(urlQuery||'')), page:String(currentPage-1) }); return p.toString(); })() %>">Previous</a>
          <% } %>
          <% if (currentPage < totalPages) { %>
            <a class="btn btn-outline-light btn-sm" href="?<%- (()=>{ const p=new URLSearchParams({ ...Object.fromEntries(new URLSearchParams(urlQuery||'')), page:String(currentPage+1) }); return p.toString(); })() %>">Next</a>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  function showToast(message, type = 'primary'){
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0 show position-fixed top-50 start-50 translate-middle`;
    toast.style.minWidth = '300px';
    toast.style.zIndex = '1055';
    toast.innerHTML = `<div class='d-flex'><div class='toast-body'>${message}</div><button class='btn-close btn-close-white me-2 m-auto' data-bs-dismiss='toast'></button></div>`;
    document.body.appendChild(toast);
    setTimeout(()=>toast.remove(), 3000);
  }

  function getParams(){
    const params = new URLSearchParams(window.location.search);
    return params;
  }

  function applyFilters(){
    const params = new URLSearchParams();
    const range = document.getElementById('range').value;
    params.append('range', range);
    if(range === 'custom'){
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      if(s) params.append('startDate', s);
      if(e) params.append('endDate', e);
    }
    window.location.href = '/admin-sales-report?' + params.toString();
  }

  function clearFilters(){
    window.location.href = '/admin-sales-report';
  }

  function toggleCustomDates(){
    const range = document.getElementById('range').value;
    const disabled = range !== 'custom';
    document.getElementById('startDate').disabled = disabled;
    document.getElementById('endDate').disabled = disabled;
  }
  toggleCustomDates();

  function pageUrl(p){
    const params = new URLSearchParams(window.location.search);
    params.set('page', p);
    return '/admin-sales-report?' + params.toString();
  }

  function downloadReport(type){
    const params = new URLSearchParams(window.location.search);
    // Remove pagination parameters to get full period data
    params.delete('page');
    params.delete('limit');
    if(type==='pdf'){
      window.location.href = '/admin-sales-report/download/pdf?' + params.toString();
    }else{
      window.location.href = '/admin-sales-report/download/excel?' + params.toString();
    }
  }
</script>

<script></script>

</body>
</html>


